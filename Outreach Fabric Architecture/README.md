# Архитектурное предложение: "Аутрич-Фабрика полного цикла"

## 1. Общая концепция

Предлагается **распределенная гибридная архитектура**. Разделяем систему на три логически изолированных слоя: **Control Plane** (мозги/данные), **MTA Core** (транспорт) и **Delivery Edge** (сеть доставки). Это позволяет менять IP-адреса и домены «на лету» без остановки бизнес-процессов, а также использовать внешний ESP как аварийный канал.

## 2. Ключевые преимущества

1. **Высокая доставляемость (Deliverability):** Используется технология «умного проксирования». Письма отправляются с десятков разных IP-адресов, имитируя ручную переписку. Тексты уникализируются ИИ, что делает их невидимыми для спам-фильтров как «массовую рассылку».
2. **Удобство для менеджеров:** Внедрение полноценной **EspoCRM**. Сотрудники работают в одном окне: видят историю переписки, статусы прочтения и могут отвечать клиентам прямо из интерфейса, не переключаясь между вкладками.
3. **Гибридная надежность:** Если наша инфраструктура попадает под массовую блокировку, система автоматически переключается на запасной платный канал (ESP), гарантируя, что важные письма уйдут клиентам в любой ситуации.

## 3. Стек технологий (Компоненты)

### A. Control Plane (Clean Zone)

*Сервер, который никогда не шлет письма. Содержит бизнес-логику и данные.*

* **EspoCRM (UI):** Open-Source CRM с нативной поддержкой email-тредов. Замена NocoDB. Менеджеры работают здесь (отвечают на письма, двигают сделки).
* **n8n (Orchestrator):** Движок workflow. Выполняет роль «умного контроллера»:
  * Забирает контакты из CRM.
  * Валидирует email (интеграция с **Reacher** или API валидатора).
  * Уникализирует текст через **OpenAI API** (Spintax + Rewrite).
  * Передает задачу в Postal по API.
  * Обрабатывает вебхуки (Bounce/Open/Click/Reply).
  * Реализует **Application-Level Throttling** (анализирует ошибки 4xx/5xx и тормозит отправку).
* **PostgreSQL:** Единая БД для CRM и n8n.

### B. MTA Core (Transport Layer)

*Движок управления очередями. Развернут в Docker.*

* **Postal:** Основной почтовый сервер.
  * Настроен на работу с множественными **IP Pools**.
  * Принимает письма от n8n по API.
  * Отправляет вебхуки (Delivery, Bounce, Click) обратно в n8n для анализа.
  * **Важно:** Не шлет письма напрямую с eth0, а маршрутизирует трафик в туннели.

### C. Delivery Edge (Dirty Zone)

*Расходный материал. Динамическая инфраструктура.*

* **Proxy Nodes:** 20–30 микро-VPS (1 vCPU / 512MB RAM) у разных провайдеров (Hetzner, Aeza, DigitalOcean, Vultr).
  * На борту: **WireGuard** (предпочтительно) или SOCKS5.
  * Ротация: При попадании IP в блэклист нода уничтожается и пересоздается скриптом (Terraform/Ansible).
* **Emergency Relay (ESP):** Подключенный аккаунт коммерческого провайдера (ElasticEmail / SMTP.com / Amazon SES) для аварийного сброса трафика.

## 4. Логика работы (Workflow)

### Шаг 1: Подготовка и Валидация

1. n8n берет пачку контактов из EspoCRM.
2. **Pre-send Check:** Email проверяется валидатором (Reacher). Если адрес невалиден — пометка в CRM, отправка отменяется (защита репутации).
3. **AI-Mutation:** Тело письма уникализируется через OpenAI (GPT-4o-mini)/Spintax, чтобы хеш-суммы писем были разными.

### Шаг 2: Отправка и Маршрутизация

1. Письмо попадает в Postal.
2. Postal выбирает **IP Pool** на основе стратегии (Warm-up для новых доменов, Trusted для старых).
3. Письмо уходит через туннель WireGuard на одну из микро-VPS и далее в интернет.
4. DKIM/SPF заголовки подписаны доменом отправителя, но физический IP принадлежит микро-VPS.

### Шаг 3: Обработка ответов и Ошибок (Feedback Loop)

1. **Успех/Ответ:** Входящее письмо приходит на Postal -> Вебхук в n8n -> Создание задачи в EspoCRM -> Остановка рассылки по этому контакту.
2. **Анализ ошибок (Throttling):**
    * Postal получает SMTP-код от Google/Outlook.
    * Шлет JSON-вебхук в n8n.
    * **Логика n8n:**
        * Если код `5xx` (Hard Bounce) -> Email в бан-лист CRM.
        * Если код `421/451` (Rate Limit) -> n8n ставит **паузу** на подачу новых писем в этот пул на 30–60 минут (Application-Level Throttling).
        * Если `Error Rate` пула > 5% -> n8n переключает отправку на **Emergency Relay (ESP)**.

## 5. Инфраструктура и Безопасность

* **Deployment:** Docker Compose для сервисов, Terraform для управления VPS-нодами.
* **Мониторинг:**
  * **Zabbix/Prometheus:** Мониторинг "здоровья" туннелей и серверов.
  * **HetrixTools API:** Ежедневная проверка всех IP и доменов в блэклистах (Spamhaus, SORBS).
* **Безопасность:** Весь межсервисный трафик внутри WireGuard VPN. Порты наружу открыты только на Proxy Nodes (25, 80, 443).

## 6. Риски и Страховка

| Риск                                | Решение в архитектуре                                                                                       |
| :---------------------------------- | :---------------------------------------------------------------------------------------------------------- |
| **Попадание писем в Спам**          | Предварительная валидация баз + ИИ-уникализация текста + Медленный «прогрев» новых доменов.                 |
| **Блокировка серверов провайдером** | Использование 3–4 разных хостингов одновременно. Автоматическая замена заблокированного сервера за 5 минут. |
| **Временный бан от Google/Outlook** | Система сама видит сигнал «притормози» (код 421) и ставит паузу, предотвращая полный бан.                   |
| **Полный отказ инфраструктуры**     | Аварийное переключение на внешний платный сервис (ESP Fallback).                                            |

## 7. Экономика решения (Оценка OPEX)

* **Инфраструктура (Серверы):**
  * Главный управляющий узел: ~4 000 руб/мес.
  * Сеть доставки (20–25 микро-серверов): ~5 000 руб/мес.
  * *Итого железо:* **~9 000 руб/мес.**
* **Домены (400 шт):**
  * Микс зон (.com, .pro, .click) для повышения траста: **~60 000 руб/год.**
* **Сервисы (AI и Валидация):**
  * OpenAI + Валидатор баз: **~2 000 – 3 000 руб/мес** (зависит от объемов).
* **Запасной канал (ESP):**
  * Pay-as-you-go (платим только в случае аварии): заложено **~1 000 руб/мес** резерва.

**Итоговый бюджет:**

* **Ежемесячно:** ~12 000 – 14 000 руб.
* **Ежегодно (Домены):** ~60 000 руб.
